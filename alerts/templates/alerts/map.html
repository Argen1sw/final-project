<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <title>EnviroAlerts</title>
    <style>
      /* General Reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
      }

      /* Navigation Bar */
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f4f4f4;
        padding: 10px 20px;
        border-bottom: 1px solid #ddd;
      }

      nav a {
        text-decoration: none;
        color: #333;
        font-weight: bold;
        padding: 5px 10px;
      }

      nav a:hover {
        background-color: #ddd;
        border-radius: 3px;
      }

      /* Main Map Section */
      #map {
        width: 100%;
        height: 400px;
        margin: 20px auto;
        border: 1px solid #ddd;
      }

      /* Alerts List */
      .alert-item {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        background-color: #fafafa;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
      }

      .alert-item strong {
        font-size: 18px;
        color: #333;
      }

      .alert-item p {
        font-size: 14px;
        color: #666;
        margin: 5px 0;
      }

      .alert-item em {
        font-style: italic;
        color: #999;
      }

      .map-container {
        max-width: 1200px; /* Controls the width of the map container */
        margin: 0 auto; /* Centers the container horizontally */
        padding: 0 20px; /* Adds padding on the left and right sides */
      }

      #map {
        width: 100%;
        height: 600px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      #alert-form {
        display: none;
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        border: 1px solid #ccc;
        z-index: 1000;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
      }

      .section-title {
        font-size: 24px;
        font-weight: bold;
        margin: 20px 0 10px 0;
        text-align: center; /* Centers the titles */
        color: #333;
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav>
      <a href="/alerts/home/">EnviroAlerts</a>
      <a href="/alerts/map/">Alerts Map</a>
      <a href="/alerts/resources/">IOT Resources</a>
      <a href="/alerts/about/">About</a>
      <a href="/alerts/login/">Login</a>
    </nav>

    <!-- Map Section -->
    <div class="map-container">
      <h2 class="section-title">Interactive Map</h2>
      <div id="map" style="height: 600px"></div>
    </div>
    <div id="alert-form">
      <h3>Add Alert</h3>
      <form id="alertForm">
        <input
          type="text"
          id="alertTitle"
          placeholder="Title"
          required
        /><br /><br />
        <textarea id="alertDescription" placeholder="Description"></textarea
        ><br /><br />

        <!-- Hazard Type Dropdown -->
        <label for="hazardType">Hazard Type:</label>
        <select id="hazardType">
          <option value="earthquake">Earthquake</option>
          <option value="flood">Flood</option>
          <option value="tornado">Tornado</option>
          <option value="fire">Fire</option>
          <option value="storm">Storm</option></select
        ><br /><br />

        <!-- Severity Field -->
        <label for="severity">Severity (1-10):</label>
        <input type="number" id="severity" min="1" max="10" /><br /><br />

        <!-- Reported By Field -->
        <label for="reportedBy">Reported By:</label>
        <input
          type="text"
          id="reportedBy"
          placeholder="Reporter Name"
        /><br /><br />

        <!-- Source URL Field -->
        <label for="sourceUrl">Source URL:</label>
        <input
          type="url"
          id="sourceUrl"
          placeholder="http://example.com"
        /><br /><br />

        <!-- Hidden Fields for Lat/Lng -->
        <input type="hidden" id="alertLat" />
        <input type="hidden" id="alertLng" />

        <!-- Submit and Cancel Buttons -->
        <button type="submit">Submit</button>
        <button type="button" onclick="hideForm()">Cancel</button>
      </form>
    </div>

    <!-- Alerts List -->
    <div class="alerts-container">
      <h2 class="section-title">Alerts List</h2>
      <div id="alertsList"></div>
    </div>

    <!-- Leaflet JS -->
    <script>
      // Initialize the map
      var map = L.map("map").setView([51.505, -0.09], 13);
      L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {}
      ).addTo(map);

      // Fetch and display all existing alerts
      fetch("/alerts/alerts/")
        .then((response) => response.json())
        .then((data) => {
          const alertsList = document.getElementById("alertsList");
          data.features.forEach((feature) => {
            const coords = feature.geometry.coordinates;
            const {
              title,
              description,
              hazard_type,
              country,
              city,
              county,
              created_at,
              reported_by,
              source_url,
            } = feature.properties;

            // Format creation date
            const creationDate = new Date(created_at).toLocaleString();

            // Add marker to the map
            L.marker([coords[1], coords[0]]) // Leaflet expects [lat, lng]
              .addTo(map).bindPopup(`
                            <b>${title} (${hazard_type})</b><br>
                            ${description}<br>
                            Reported by: ${reported_by || "Unknown"}<br>
                            <a href="${source_url}" target="_blank">More Info</a>
                        `);

            // Add alert to the list dynamically
            const alertDiv = document.createElement("div");
            alertDiv.classList.add("alert-item");
            alertDiv.innerHTML = `
                        <strong>${title} (${hazard_type})</strong>
                        <p>${description}</p>
                        <p>Location: ${
                          city || county || country || "Unknown"
                        }</p>
                        <p>Reported by: ${reported_by || "Unknown"}</p>
                        <p><a href="${source_url}" target="_blank">More Info</a></p>
                        <p><em>Created on: ${creationDate}</em></p>
                    `;
            alertsList.appendChild(alertDiv);
          });
        })
        .catch((error) => console.error("Error fetching alerts:", error));

      map.on("click", function (e) {
        document.getElementById("alertLat").value = e.latlng.lat;
        document.getElementById("alertLng").value = e.latlng.lng;
        showForm();
      });

      function showForm() {
        document.getElementById("alert-form").style.display = "block";
      }

      function hideForm() {
        document.getElementById("alert-form").style.display = "none";
      }

      // Function to get the CSRF token from cookies
      function getCSRFToken() {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith("csrftoken=")) {
              cookieValue = cookie.substring("csrftoken=".length);
              break;
            }
          }
        }
        return cookieValue;
      }

      document
        .getElementById("alertForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const data = {
            title: document.getElementById("alertTitle").value,
            description: document.getElementById("alertDescription").value,
            lat: document.getElementById("alertLat").value,
            lng: document.getElementById("alertLng").value,
            hazard_type: document.getElementById("hazardType").value,
            severity: document.getElementById("severity").value,
            reported_by: document.getElementById("reportedBy").value,
            source_url: document.getElementById("sourceUrl").value,
          };

          fetch("/alerts/create_alerts/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCSRFToken(), // Add the CSRF token here
            },
            body: JSON.stringify(data),
          })
            .then((response) => response.json())
            .then((alert) => {
              // Add marker to the map
              L.marker([
                alert.location.coordinates[1],
                alert.location.coordinates[0],
              ]).addTo(map).bindPopup(`
                        <b>${alert.title} (${alert.hazard_type})</b><br>
                        ${alert.description}<br>
                        Reported by: ${alert.reported_by || "Unknown"}<br>
                        <a href="${
                          alert.source_url
                        }" target="_blank">More Info</a>
                    `);

              // Dynamically add the alert to the list
              const alertsList = document.getElementById("alertsList");
              const alertDiv = document.createElement("div");
              alertDiv.classList.add("alert-item");
              alertDiv.innerHTML = `
                    <strong>${alert.title} (${alert.hazard_type})</strong>
                    <p>${alert.description}</p>
                    <p>Location: Unknown</p>
                    <p>Reported by: ${alert.reported_by || "Anonymous"}</p>
                    <p><a href="${
                      alert.source_url
                    }" target="_blank">More Info</a></p>
                    <p><em>Created on: ${new Date(
                      alert.created_at
                    ).toLocaleString()}</em></p>
                `;
              alertsList.appendChild(alertDiv);

              hideForm();
            })
            .catch((error) => console.error("Error:", error));
        });
    </script>
  </body>
</html>
